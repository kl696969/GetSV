name: Fetch and clean server list with UTF-8 fix

on:
  schedule:
    - cron: '0 * * * *'  # chạy mỗi giờ
  workflow_dispatch:

jobs:
  fetch_clean_save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Fetch and process with encoding fix
        run: |
          > temp_raw.txt

          # Hàm tải file và đảm bảo có dấu , cuối cùng
          fetch_with_comma() {
            curl -s "$1" | sed '$s/[^,]$/.&,/; $s/,$//; $s/$/,/' >> temp_raw.txt
          }

          fetch_with_comma http://dangky.hexat.com/lau.txt
          fetch_with_comma http://112.213.94.5/srvips/sv.txt
          fetch_with_comma http://tuananh0781.hexat.com/19951999dshgkjd.txt
          fetch_with_comma http://kpah99.com/nqsh9.txt
          fetch_with_comma http://rkbom.site/ip/svmoi.txt
          fetch_with_comma http://sv.naska.com.vn/allsv.txt

          # Chuyển mã hóa từ Windows-1258 → UTF-8 nếu cần
          iconv -f WINDOWS-1258 -t UTF-8 temp_raw.txt -o temp_utf8.txt || cp temp_raw.txt temp_utf8.txt

          # Chuẩn hóa: tách dòng theo , rồi thêm @ cuối mỗi dòng
          cat temp_utf8.txt | tr ',\r' '\n' > step1.txt
          grep -v '^$' step1.txt > step2.txt
          sed 's/ *@*$/@/' step2.txt > step3.txt
          sort step3.txt | uniq > step4.txt

          # Xoá dòng @ cuối nếu có
          sed '${s/@$//}' step4.txt > combined.txt

          rm temp_raw.txt temp_utf8.txt step1.txt step2.txt step3.txt step4.txt

      - name: Commit and push combined.txt
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add combined.txt
          git commit -m "Update combined.txt at $(date -u)" || echo "Nothing to commit"

          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:main
