name: Fetch and clean server list with UTF-8 fix

on:
  schedule:
    - cron: '0 * * * *'  # chạy mỗi giờ
  workflow_dispatch:

jobs:
  fetch_clean_save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Fetch and process with encoding fix
        run: |
          > temp_raw.txt

          # Hàm tải file và đảm bảo có dấu , ở dòng cuối
          fetch_with_comma() {
            curl -s "$1" | sed '$s/[^,]$/.&,/; $s/,$//; $s/$/,/' >> temp_raw.txt
          }

          fetch_with_comma http://112.213.94.5/srvips/sv.txt
          fetch_with_comma http://rkbom.site/ip/svmoi.txt

          # Chuyển mã hóa từ Windows-1258 → UTF-8
          iconv -f WINDOWS-1258 -t UTF-8 temp_raw.txt -o temp_utf8.txt || cp temp_raw.txt temp_utf8.txt

          # Xoá BOM nếu có (ký tự ï»¿ ở đầu)
          sed -i '1s/^\xEF\xBB\xBF//' temp_utf8.txt

          # Tách dòng theo dấu , và chuẩn hóa
          tr ',\r' '\n' < temp_utf8.txt > step1.txt
          grep -v '^$' step1.txt > step2.txt

          # Thêm @ nếu chưa có
          sed 's/ *@*$/@/' step2.txt > step3.txt

          # Lọc trùng theo IP:PORT
          awk -F: '!a[$2":"$3]++' step3.txt > step4.txt

          # Xoá @ ở dòng cuối cùng nếu có
          sed '${s/@$//}' step4.txt > fullsv.txt

          rm temp_raw.txt temp_utf8.txt step1.txt step2.txt step3.txt step4.txt

      - name: Commit and push fullsv.txt
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add fullsv.txt
          git commit -m "Update fullsv.txt at $(date -u)" || echo "Nothing to commit"

          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:main
